# カーソル、コミット、ロールバックの関係（ざっくり解説）

データベースの操作を「オンラインショッピング」に例えて考えてみましょう。

### 登場人物

| DB用語 | 例え | 役割 |
| :--- | :--- | :--- |
| **トランザクション** | **一回の買い物** | カートに商品を入れてから、決済を完了するまでの一連の流れ。 |
| **カーソル** | **買い物リスト** | 「お菓子カテゴリの商品」など、処理したい対象をまとめたリスト。 |
| **コミット** | **購入確定ボタン** | これを押すと、もうキャンセルできない。商品が発送され、お金が引かれる。 |
| **ロールバック** | **カートを空にする** | 何か問題があったときに、カートを空にして買い物前の状態に戻すこと。 |

---

### 処理の流れ：『「お菓子」の値段を全部10円上げる』場合

1.  **「これから作業を始めます！」と宣言 (トランザクション開始)**
    *   データベースに対する一連の作業（今回の買い物）が始まります。
    *   ここから先に行う変更は、まだ「仮の変更」です。

2.  **「お菓子」のリストをもらう (カーソルを用意)**
    *   `SELECT * FROM products WHERE category = 'お菓子'` のような命令で、対象となる商品のリスト（カーソル）を作ります。

3.  **リストを上から順に処理する (カーソルでループ)**
    *   1つ目のお菓子を取り出し、値段を10円上げる（まだ仮の変更）。
    *   2つ目のお菓子を取り出し、値段を10円上げる（まだ仮の変更）。
    *   ...とリストの最後まで繰り返します。

4.  **最後の決断 (コミット or ロールバック)**
    *   **【成功パターン】**
        *   リストの最後まで、何の問題もなく処理が完了した。
        *   **`COMMIT` (購入確定) を実行！**
        *   これまでの「仮の変更」がすべてデータベースに正式に記録されます。作業完了です。

    *   **【失敗パターン】**
        *   途中の商品でエラーが発生して、処理が止まってしまった。
        *   **`ROLLBACK` (カートを空にする) を実行！**
        *   それまでに行った「仮の変更」が**すべて取り消され**、作業を始める前の状態に完全に元どおりになります。

### まとめ

- **カーソル**は、たくさんのデータを1件ずつ料理するための道具（forループみたいなもの）。
- その一連の料理（処理）全体を「成功」させるのが**コミット**。
- 途中で失敗したときに「全部なかったこと」にするのが**ロールバック**。

この仕組みがあるおかげで、「一部の商品の値段だけ上がって、残りは古いまま」といった中途半端な状態が防がれ、データの安全性が保たれています。
