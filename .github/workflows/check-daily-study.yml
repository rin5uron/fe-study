name: æ¯æ—¥ã®å‹‰å¼·è¨˜éŒ²ãƒã‚§ãƒƒã‚¯

on:
  schedule:
    # æ¯æ—¥æœ5:00 JST (20:00 UTC å‰æ—¥) ã«å®Ÿè¡Œï¼ˆå‰æ—¥ã®è¨˜éŒ²ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰
    - cron: '0 20 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  check-daily-study:
    runs-on: ubuntu-latest
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: å‰æ—¥ã®æ—¥ä»˜ã‚’å–å¾—
        id: date
        run: |
          # UTCæ™‚é–“ã§å‰æ—¥ã®æ—¥ä»˜ã‚’å–å¾—ï¼ˆJSTã®æœ5æ™‚ã¯UTCã®å‰æ—¥20æ™‚ï¼‰
          TZ='Asia/Tokyo' date -d "1 day ago" +%Y-%m-%d > date.txt || TZ='Asia/Tokyo' date -v-1d +%Y-%m-%d > date.txt
          echo "date=$(cat date.txt)" >> $GITHUB_OUTPUT
          echo "å‰æ—¥ã®æ—¥ä»˜: $(cat date.txt)"
      
      - name: å‰æ—¥ã®å‹‰å¼·è¨˜éŒ²Issueã‚’ãƒã‚§ãƒƒã‚¯
        id: check-issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const yesterday = `${{ steps.date.outputs.date }}`;
            const studyLabel = 'daily-study';
            
            console.log(`å‰æ—¥ï¼ˆ${yesterday}ï¼‰ã®å‹‰å¼·è¨˜éŒ²ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¾ã™`);
            
            // å‰æ—¥ã®æ—¥ä»˜ã‚’å«ã‚€ã‚¿ã‚¤ãƒˆãƒ«ã®issueã‚’æ¤œç´¢
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: studyLabel,
              state: 'all',
              per_page: 100,
              sort: 'created',
              direction: 'desc'
            });
            
            // å‰æ—¥ã®æ—¥ä»˜ã‚’å«ã‚€issueã‚’æ¢ã™ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã¾ãŸã¯æœ¬æ–‡ã«æ—¥ä»˜ãŒå«ã¾ã‚Œã‚‹ï¼‰
            const yesterdayIssues = issues.data.filter(issue => {
              const titleMatch = issue.title.includes(yesterday);
              const bodyMatch = issue.body && issue.body.includes(yesterday);
              // ä½œæˆæ—¥ãŒå‰æ—¥ã‹ã©ã†ã‹ã‚‚ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è€ƒæ…®ï¼‰
              const createdDate = new Date(issue.created_at);
              const yesterdayDate = new Date(yesterday + 'T00:00:00+09:00');
              const todayDate = new Date(yesterdayDate);
              todayDate.setDate(todayDate.getDate() + 1);
              const isYesterday = createdDate >= yesterdayDate && createdDate < todayDate;
              
              return titleMatch || bodyMatch || isYesterday;
            });
            
            // å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ©ãƒ™ãƒ«ã‚’ç¢ºèª
            const users = ['user-rin5uron']; // ã“ã“ã«å‚åŠ è€…ã®ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ï¼ˆä¾‹: ['user-rin5uron', 'user-partner']ï¼‰
            const missingUsers = [];
            
            for (const userLabel of users) {
              const userIssue = yesterdayIssues.find(issue => 
                issue.labels.some(label => label.name === userLabel)
              );
              
              if (!userIssue) {
                missingUsers.push(userLabel);
                console.log(`${userLabel} ã®å‰æ—¥ã®è¨˜éŒ²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ`);
              } else {
                console.log(`${userLabel} ã®å‰æ—¥ã®è¨˜éŒ²ã‚’ç¢ºèªã—ã¾ã—ãŸ`);
              }
            }
            
            // çµæœã‚’å‡ºåŠ›
            if (missingUsers.length > 0) {
              console.log(`æœªæå‡ºã®ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${missingUsers.join(', ')}`);
              core.setOutput('missing_users', missingUsers.join(','));
              core.setOutput('has_penalty', 'true');
            } else {
              console.log('å…¨å“¡æå‡ºæ¸ˆã¿ã§ã™ï¼');
              core.setOutput('has_penalty', 'false');
            }
      
      - name: ãƒšãƒŠãƒ«ãƒ†ã‚£è¨˜éŒ²Issueã‚’ä½œæˆ/æ›´æ–°
        if: steps.check-issues.outputs.has_penalty == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const yesterday = `${{ steps.date.outputs.date }}`;
            const missingUsers = `${{ steps.check-issues.outputs.missing_users }}`.split(',').filter(u => u.trim());
            const penaltyAmount = 3000;
            
            // ãƒšãƒŠãƒ«ãƒ†ã‚£ç®¡ç†ç”¨ã®issueã‚’æ¤œç´¢
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'penalty-log',
              state: 'open',
              per_page: 10
            });
            
            let penaltyIssue = issues.data.find(issue => 
              issue.title.includes('ãƒšãƒŠãƒ«ãƒ†ã‚£è¨˜éŒ²')
            );
            
            // ãƒšãƒŠãƒ«ãƒ†ã‚£è¨˜éŒ²issueãŒãªã‘ã‚Œã°ä½œæˆ
            if (!penaltyIssue) {
              penaltyIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ’° ãƒšãƒŠãƒ«ãƒ†ã‚£è¨˜éŒ²',
                body: `# ãƒšãƒŠãƒ«ãƒ†ã‚£è¨˜éŒ²\n\næœªæå‡ºæ—¥ã®ãƒšãƒŠãƒ«ãƒ†ã‚£ï¼ˆ${penaltyAmount}å††ï¼‰ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚\n\n---\n\n`,
                labels: ['penalty-log']
              });
            }
            
            // å‰æ—¥ã®ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦è¿½åŠ 
            const comment = `## ${yesterday} ã®ãƒšãƒŠãƒ«ãƒ†ã‚£\n\n`;
            const userPenalties = missingUsers.map(user => {
              const userName = user.replace('user-', '');
              return `- **@${userName}**: ${penaltyAmount}å††`;
            }).join('\n');
            
            const total = missingUsers.length * penaltyAmount;
            const fullComment = comment + userPenalties + `\n\n**åˆè¨ˆ**: ${total}å††\n\n---\n\n`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: penaltyIssue.data.number,
              body: fullComment
            });
            
            console.log(`${yesterday} ã®ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ: ${missingUsers.join(', ')}`);
      
      - name: æˆåŠŸé€šçŸ¥
        if: steps.check-issues.outputs.has_penalty == 'false'
        run: |
          echo "âœ… å…¨å“¡ãŒå‰æ—¥ã®å‹‰å¼·è¨˜éŒ²ã‚’æå‡ºã—ã¾ã—ãŸï¼"
