name: æ¯æ—¥ã®å‹‰å¼·è¨˜éŒ²ãƒã‚§ãƒƒã‚¯

on:
  schedule:
    # æ¯æ—¥23:00 JST (14:00 UTC) ã«å®Ÿè¡Œ
    - cron: '0 14 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  check-daily-study:
    runs-on: ubuntu-latest
    
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
      
      - name: æ—¥ä»˜ã‚’å–å¾—
        id: date
        run: |
          TZ='Asia/Tokyo' date +%Y-%m-%d > date.txt
          echo "date=$(cat date.txt)" >> $GITHUB_OUTPUT
      
      - name: ä»Šæ—¥ã®å‹‰å¼·è¨˜éŒ²Issueã‚’ãƒã‚§ãƒƒã‚¯
        id: check-issues
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const today = `${{ steps.date.outputs.date }}`;
            const studyLabel = 'daily-study';
            
            // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å«ã‚€ã‚¿ã‚¤ãƒˆãƒ«ã®issueã‚’æ¤œç´¢
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: studyLabel,
              state: 'all',
              per_page: 100,
              sort: 'created',
              direction: 'desc'
            });
            
            // ä»Šæ—¥ã®æ—¥ä»˜ã‚’å«ã‚€issueã‚’æ¢ã™ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã¾ãŸã¯æœ¬æ–‡ã«æ—¥ä»˜ãŒå«ã¾ã‚Œã‚‹ï¼‰
            const todayIssues = issues.data.filter(issue => {
              const titleMatch = issue.title.includes(today);
              const bodyMatch = issue.body && issue.body.includes(today);
              // ä½œæˆæ—¥ãŒä»Šæ—¥ã‹ã©ã†ã‹ã‚‚ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³è€ƒæ…®ï¼‰
              const createdDate = new Date(issue.created_at);
              const todayDate = new Date(today + 'T00:00:00+09:00');
              const tomorrowDate = new Date(todayDate);
              tomorrowDate.setDate(tomorrowDate.getDate() + 1);
              const isToday = createdDate >= todayDate && createdDate < tomorrowDate;
              
              return titleMatch || bodyMatch || isToday;
            });
            
            // å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ©ãƒ™ãƒ«ã‚’ç¢ºèª
            const users = ['user-rin5uron']; // ã“ã“ã«å‚åŠ è€…ã®ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ï¼ˆä¾‹: ['user-rin5uron', 'user-partner']ï¼‰
            const missingUsers = [];
            
            for (const userLabel of users) {
              const userIssue = todayIssues.find(issue => 
                issue.labels.some(label => label.name === userLabel)
              );
              
              if (!userIssue) {
                missingUsers.push(userLabel);
              }
            }
            
            // çµæœã‚’å‡ºåŠ›
            if (missingUsers.length > 0) {
              console.log(`æœªæå‡ºã®ãƒ¦ãƒ¼ã‚¶ãƒ¼: ${missingUsers.join(', ')}`);
              core.setOutput('missing_users', missingUsers.join(','));
              core.setOutput('has_penalty', 'true');
            } else {
              console.log('å…¨å“¡æå‡ºæ¸ˆã¿ã§ã™ï¼');
              core.setOutput('has_penalty', 'false');
            }
      
      - name: ãƒšãƒŠãƒ«ãƒ†ã‚£è¨˜éŒ²Issueã‚’ä½œæˆ/æ›´æ–°
        if: steps.check-issues.outputs.has_penalty == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const today = `${{ steps.date.outputs.date }}`;
            const missingUsers = `${{ steps.check-issues.outputs.missing_users }}`.split(',');
            const penaltyAmount = 3000;
            
            // ãƒšãƒŠãƒ«ãƒ†ã‚£ç®¡ç†ç”¨ã®issueã‚’æ¤œç´¢
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: 'penalty-log',
              state: 'open',
              per_page: 10
            });
            
            let penaltyIssue = issues.data.find(issue => 
              issue.title.includes('ãƒšãƒŠãƒ«ãƒ†ã‚£è¨˜éŒ²')
            );
            
            // ãƒšãƒŠãƒ«ãƒ†ã‚£è¨˜éŒ²issueãŒãªã‘ã‚Œã°ä½œæˆ
            if (!penaltyIssue) {
              penaltyIssue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ğŸ’° ãƒšãƒŠãƒ«ãƒ†ã‚£è¨˜éŒ²',
                body: `# ãƒšãƒŠãƒ«ãƒ†ã‚£è¨˜éŒ²\n\næœªæå‡ºæ—¥ã®ãƒšãƒŠãƒ«ãƒ†ã‚£ï¼ˆ${penaltyAmount}å††ï¼‰ã‚’è¨˜éŒ²ã—ã¾ã™ã€‚\n\n---\n\n`,
                labels: ['penalty-log']
              });
            }
            
            // ä»Šæ—¥ã®ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’ã‚³ãƒ¡ãƒ³ãƒˆã¨ã—ã¦è¿½åŠ 
            const comment = `## ${today} ã®ãƒšãƒŠãƒ«ãƒ†ã‚£\n\n`;
            const userPenalties = missingUsers.map(user => {
              const userName = user.replace('user-', '');
              return `- **@${userName}**: ${penaltyAmount}å††`;
            }).join('\n');
            
            const total = missingUsers.length * penaltyAmount;
            const fullComment = comment + userPenalties + `\n\n**åˆè¨ˆ**: ${total}å††\n\n---\n\n`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: penaltyIssue.data.number,
              body: fullComment
            });
            
            console.log(`ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’è¨˜éŒ²ã—ã¾ã—ãŸ: ${missingUsers.join(', ')}`);
      
      - name: æˆåŠŸé€šçŸ¥
        if: steps.check-issues.outputs.has_penalty == 'false'
        run: |
          echo "âœ… å…¨å“¡ãŒä»Šæ—¥ã®å‹‰å¼·è¨˜éŒ²ã‚’æå‡ºã—ã¾ã—ãŸï¼"
